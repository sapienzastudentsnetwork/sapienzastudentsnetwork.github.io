{{ define "main" }}
{{ partial "timetable.html" . }}

{{ $pageDegreeCode := .Params.degreeCode }}

<h1>{{ T "Subjs_CustomTimetable_Title" }}</h1>

<!--{{ $excludedCodes := slice "33503" "33502" }}
    {{ if not (in $excludedCodes $pageDegreeCode) }}
        ⚠️ {{ T "Subjs_WorkInProgress" }}
    {{ end }}-->

<article class="markdown book-article">
    <details>
        <summary>{{ T "Subjs_Info_Title" }}</summary>
        <ul>
            <li>{{ T "Subjs_Info_Text_1" }}</li>
            <li>{{ T "Subjs_Info_Text_2" }}</li>
            <li>{{ T "Subjs_Info_Text_3" }} Matteo <b>Collica</b> (<a href="https://telegram.me/Matypist">Telegram</a> | <a href="mailto:collica.2004949@studenti.uniroma1.it">Email</a>) {{ T "Subjs_Info_Text_4" }}</li>
        </ul>
    </details>

    <blockquote class="book-hint tip">
        <i class="fa-solid fa-lightbulb" style="color: #238636;"></i> {{ T "Subjs_Info_Tip" }}
    </blockquote>
</article>

<div class="relative" id="main">
    <!-- TODO: customizzare il pulsante con lo stile https://m3.material.io/components/all-buttons -->
    <button class="addSubjs absolute right-0 top-2 flex items-center gap-2" onclick="openSubjectsDialog()">
        {{ T "Subjs_CustomTimetable_AddButton" }}
        <!-- <span class="material-symbols-outlined">add</span> -->
    </button>
    <!-- { .Content } -->
    {{ $days := slice "Monday" "Tuesday" "Wednesday" "Thursday" "Friday" }}

    <!-- { comment }} <div> around table is necessary for alerts { endcomment }} -->
    <div class="my-8 w-full max-w-5xl mx-auto overflow-x-auto">
        <table id="customSchedule" class="w-full border-collapse shadow-lg">
            <thead>
                <tr>
                    <th scope="col" class="timetableTableCell font-light sticky left-0 z-10">
                        {{ T "Subjs_Timetables_Time" }}</th>
                    {{ range $days }}
                    <th class="timetableTableCell" scope="col">{{ T (printf
                        "DaysOfTheWeek_%s" .) }}</th>
                    {{ end }}
                </tr>
            </thead>
            <tbody class="desktop hidden sm:table-row-group"></tbody>
            <tbody class="mobile table-row-group sm:hidden"></tbody>
        </table>
    </div>

    <button class="addSubjs mb-8 flex items-center gap-2" onclick="openIcsDialog()">
        {{ T "Subjs_ExportIcsButton" }}
        <!-- <span class="material-symbols-outlined">add</span> -->
    </button>
</div>

<dialog class="ml-0 h-full items-center rounded-r-3xl p-4 shadow-xl backdrop:backdrop-blur-sm" id="exportIcsDialog" 
    onclick="closeIcsDialog()">
    <div class="subjsDial flex h-full w-full flex-col items-start">
        <h2 id="subjsSelTitle">{{ T "Subjs_ExportIcs_Title" }}</h2>
        <p>{{ T "Subjs_ExportIcs_Description" }}</p>

        <div id="exportChoiceContainer">
            <button onclick="exportIcsForSemester(1)" class="exportIcsButton">{{ T "Subjs_ExportIcs_FirstSemester" }}</button>
            <button onclick="exportIcsForSemester(2)" class="exportIcsButton">{{ T "Subjs_ExportIcs_SecondSemester" }}</button>
        </div>
        
        <button id="subjsCloseMenu" onclick="closeIcsDialog()">
            {{ T "Subjs_CustomTimetable_CloseMenuButton" }}
        </button>
    </div>
</dialog>

<dialog class="ml-0 h-full items-center rounded-r-3xl p-4 shadow-xl backdrop:backdrop-blur-sm" id="subjsPopUp"
    onclick="closeSubjectsDialog()">
    <div class="subjsDial flex h-full w-full flex-col items-start">
        <h2 id="subjsSelTitle">{{ T "Subjs_CustomTimetable_SelectMenuTitle" }}</h2>
        <div class="subjsList mb-4 h-full w-full overflow-y-scroll pr-4">
            {{ $courses := site.Data.courses }}

            {{ $degrees := dict }}
            {{ if or (eq $pageDegreeCode "33503") (eq $pageDegreeCode "33502") }}
                {{ $degrees = dict "33503" "Informatica" "33502" "ACSAI" }}
            {{ else if or (eq $pageDegreeCode "33508") (eq $pageDegreeCode "33516") }}
                {{ $degrees = dict "33508" "Computer Science" "33516" "Cybersecurity" }}
            {{ else }}
                {{ $degrees = dict "33503" "Informatica" "33502" "ACSAI" "33508" "Computer Science" "33516" "Cybersecurity"
            }}
            {{ end }}

            {{ $colors := dict "33503" "#709DD1" "33502" "#B15252" "33508" "#49C15B" "33516" "#FCC005" }}

            {{ $hardcodedDataTimetables := site.Data.hardcodedTimetables }}
            {{ $dataTimetables := site.Data.timetables }}
            {{ $allCourses := dict }}
            {{ $pageDegreeSubjects := slice }}

            {{ range $courseCode, $courseData := $dataTimetables }}
                {{ $allCourses = merge $allCourses (dict $courseCode $courseData) }}

                {{ if index $degrees $courseData.degree }}
                    {{ $pageDegreeSubjects = $pageDegreeSubjects | append $courseCode }}
                {{ end }}
            {{ end }}

            {{ range $courseCode, $courseData := $hardcodedDataTimetables }}
                {{ $allCourses = merge $allCourses (dict $courseCode $courseData) }}

                {{ if index $degrees $courseData.degree }}
                    {{ $pageDegreeSubjects = $pageDegreeSubjects | append $courseCode }}
                {{ end }}
            {{ end }}

            {{ range $degreeCode, $degreeName := $degrees }}
            <h2 class="subjsGroupTitle" id="subjs{{ $degreeName }}">
                <span style="color: {{ index $colors $degreeCode }}">{{ $degreeName }}</span>
                <span style="font-size: 14px; font-weight: 300;">({{ $degreeCode }})</span>
            </h2>

            <div class="subjsSingCourse">
                {{ range $code, $data := $allCourses }}
                    {{ if eq $data.degree $degreeCode }}
                        {{ $subject_info := index $courses $code }}
                        {{ range $channel_id, $_ := $data.channels }}
                        <button id="dialog-{{ $code }}-{{ $channel_id }}"
                            class="c-{{ $data.degree }} subjButton group mb-2 flex h-12 w-72 items-center px-4 py-1"
                            onclick="event.stopPropagation(); toggleSubject(`{{ $code }}-{{ $channel_id }}`)">
                            <span class="w-full truncate text-left">
                                {{ $subject_info.name }}
                                {{ if ne $channel_id "0" }}
                                    {{ if eq $channel_id "1" }}
                                        (A-L)
                                    {{ else if eq $channel_id "2" }}
                                        (M-Z)
                                    {{ else }}
                                        (Canale {{ $channel_id }})
                                    {{ end }}
                                {{ end }}
                            </span>
                        </button>
                        {{ end }}
                    {{ end }}
                {{ end }}
            </div>

            <div style="width: 99%; height: 1px; background-color: #444; margin: 20px auto 0 auto;"></div>
            {{ end }}
        </div>
        <button id="subjsCloseMenu" onclick="closeSubjectsDialog()">
            {{ T "Subjs_CustomTimetable_CloseMenuButton" }}
        </button>
    </div>
</dialog>

<!-- Add the "Timetables per teaching" part for all courses -->
{{ with dict "courses" $pageDegreeSubjects "defaultHidden" true }}
    {{ partial "timetables-per-teaching.html" . }}
{{ end }}

<script>
    const pageDegreeSubjects = new Set(
        JSON.parse(`{{ $pageDegreeSubjects | jsonify }}`)
    );

    const selectedSubjects = new Set(
        JSON.parse(localStorage.getItem("selectedSubjects")),
    );

    const tzid = "Europe/Rome";

    const weekdayMap = {
        monday: 1,
        tuesday: 2,
        wednesday: 3,
        thursday: 4,
        friday: 5,
        saturday: 6,
        sunday: 0,
    };

    const dayToIcs = {
        sunday: "SU",
        monday: "MO",
        tuesday: "TU",
        wednesday: "WE",
        thursday: "TH",
        friday: "FR",
        saturday: "SA",
    };

    function toggleSubject(subjectId) {
        let button = document.getElementById("dialog-" + subjectId);

        if (selectedSubjects.has(subjectId)) {  // If subject is in JSON, then remove it
            if (button.classList.contains("c-33502-disabled")) {
                button.classList.remove("c-33502-disabled")
                button.classList.add("c-33502")
            } else if (button.classList.contains("c-33508-disabled")) {
                button.classList.remove("c-33508-disabled")
                button.classList.add("c-33508")
            } else if (button.classList.contains("c-33516-disabled")) {
                button.classList.remove("c-33516-disabled")
                button.classList.add("c-33516")
            } else if (button.classList.contains("c-33503-disabled")) {
                button.classList.remove("c-33503-disabled")
                button.classList.add("c-33503")
            }

            button.classList.remove(
                "bg-black",
                "text-white",
                "dark:bg-white",
                "dark:text-black",
                "subjIsSelected"
            );
            button.classList.add(
                "bg-gray-50",
                "dark:bg-gray-900",
                "dark:text-white",
            );

            let subjectCode = subjectId.split("-")[0];

            // Hide this subject's timetable div only if the subject was not also added with another channel
            let otherSubjectIdsWithSameCode = Array.from(
                selectedSubjects,
            ).filter((item) => item.startsWith(subjectCode));
            if (otherSubjectIdsWithSameCode.length === 1) {
                let subject_div = document.getElementById(subjectCode);
                if (subject_div) subject_div.classList.add("hidden");
            }

            let channel_div = document.getElementById(subjectId);
            if (channel_div) channel_div.classList.add("hidden");

            selectedSubjects.delete(subjectId);
        } else {    // If subject is not in the JSON, then add it
            if (button.classList.contains("c-33502")) {
                button.classList.add("c-33502-disabled")
                button.classList.remove("c-33502")
            } else if (button.classList.contains("c-33508")) {
                button.classList.add("c-33508-disabled")
                button.classList.remove("c-33508")
            } else if (button.classList.contains("c-33516")) {
                button.classList.add("c-33516-disabled")
                button.classList.remove("c-33516")
            } else if (button.classList.contains("c-33503")) {
                button.classList.add("c-33503-disabled")
                button.classList.remove("c-33503")
            }

            button.classList.remove(
                "bg-gray-50",
                "dark:bg-gray-900",
                "dark:text-white",
            );
            button.classList.add(
                "bg-black",
                "text-white",
                "dark:bg-white",
                "dark:text-black",
                "subjIsSelected"
            );

            let subjectCode = subjectId.split("-")[0];
            let subject_div = document.getElementById(subjectCode);
            if (subject_div) subject_div.classList.remove("hidden");

            let channel_div = document.getElementById(subjectId);
            if (channel_div) channel_div.classList.remove("hidden");

            selectedSubjects.add(subjectId);
        }

        localStorage.setItem(
            "selectedSubjects",
            JSON.stringify(Array.from(selectedSubjects)),
        );

        fillTimetable("customSchedule", Array.from(selectedSubjects), Array.from(pageDegreeSubjects), 0);
    }

    function pad(num) {
        return num.toString().padStart(2, "0");
    }

    // Format datetime in ICS style (UTC)
    function formatDateTime(date, hour) {
        const d = new Date(date);
        return (
            d.getUTCFullYear() +
            pad(d.getUTCMonth() + 1) +
            pad(d.getUTCDate()) +
            "T" +
            pad(hour) + "0000"
        );
    }

    function generateICS(schedule, semester) {
        const year = new Date().getFullYear();

        // Decide the start/end dates based on semester
        let startDate, endDate;
        if (semester === 1) {
            startDate = new Date(`${year}-09-15`);
            endDate = new Date(`${year + 1}-02-25`);
        } else if (semester === 2) {
            startDate = new Date(`${year}-02-25`);
            endDate = new Date(`${year}-06-15`);
        } else {
            throw new Error("Semester must be 1 or 2");
        }

        let events = "";

        for (const [day, lectures] of Object.entries(schedule)) {
            for (const lecture of lectures) {
            if (lecture.cancelled) continue;

            // Find the first occurrence of this weekday on or after startDate
            const first = new Date(startDate);
            while (first.getDay() !== weekdayMap[day]) {
                first.setDate(first.getDate() + 1);
            }

            const dtStart = formatDateTime(first, lecture.startTime);
            const dtEnd = formatDateTime(first, lecture.endTime);

            events += `BEGIN:VEVENT
SUMMARY:[${COURSES[lecture.courseCode].abbr}] ${COURSES[lecture.courseCode].name}
DESCRIPTION:Classroom ${lecture.classroomName || "N/A"}`

            if (COURSES[lecture.courseCode].tgGroup) {
                events += `\\nTelegram group: ${COURSES[lecture.courseCode].tgGroup}`;
            }

            events += `
LOCATION:${lecture.classroomName}
DTSTART;TZID=${tzid}:${dtStart}
DTEND;TZID=${tzid}:${dtEnd}
RRULE:FREQ=WEEKLY;BYDAY=${dayToIcs[day]};UNTIL=${endDate.getUTCFullYear()}${pad(endDate.getUTCMonth() + 1)}${pad(endDate.getUTCDate())}T235959Z
END:VEVENT
`;
            }
        }

        const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VTIMEZONE
TZID:${tzid}
X-LIC-LOCATION:${tzid}
BEGIN:STANDARD
TZOFFSETFROM:+0200
TZOFFSETTO:+0100
TZNAME:CET
DTSTART:19701025T030000
RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU
END:STANDARD
BEGIN:DAYLIGHT
TZOFFSETFROM:+0100
TZOFFSETTO:+0200
TZNAME:CEST
DTSTART:19700329T020000
RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU
END:DAYLIGHT
END:VTIMEZONE
${events}END:VCALENDAR`;

        return icsContent;
    }

    function scheduleIsEmpty(schedule) {
        return Object.values(schedule).every(lectures => lectures.length === 0);
    }

    function exportIcsForSemester(semester) {
        var [ schedule, _, _ ] = parseSchedule(Array.from(selectedSubjects), Array.from(pageDegreeSubjects), 0);

        if (scheduleIsEmpty(schedule)) {
            alert("{{ T "Subjs_ExportIcs_NoSubjectsSelected" }}");
            return;
        }

        icsContent = generateICS(schedule, semester);

        const blob = new Blob([icsContent], { type: "text/calendar" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "schedule.ics";
        a.click();

        URL.revokeObjectURL(url);
    }

    addEventListener("DOMContentLoaded", () => {
        for (const subjectId of selectedSubjects) {
            const button = document.getElementById("dialog-" + subjectId);

            if (button) { // Check if the button exists
                if (button.classList.contains("c-33502")) {
                    button.classList.add("c-33502-disabled");
                    button.classList.remove("c-33502");
                } else if (button.classList.contains("c-33508")) {
                    button.classList.add("c-33508-disabled");
                    button.classList.remove("c-33508");
                } else if (button.classList.contains("c-33516")) {
                    button.classList.add("c-33516-disabled");
                    button.classList.remove("c-33516");
                } else if (button.classList.contains("c-33503")) {
                    button.classList.add("c-33503-disabled");
                    button.classList.remove("c-33503");
                }

                button.classList.remove(
                    "bg-gray-50",
                    "dark:bg-gray-900",
                    "dark:text-white",
                );
                button.classList.add(
                    "bg-black",
                    "text-white",
                    "dark:bg-white",
                    "dark:text-black",
                    "subjIsSelected"
                );
            }

            let subjectCode = subjectId.split("-")[0];
            let subject_div = document.getElementById(subjectCode);
            if (subject_div) subject_div.classList.remove("hidden");

            let channel_div = document.getElementById(subjectId);
            if (channel_div) channel_div.classList.remove("hidden");
        }

        fillTimetable("customSchedule", Array.from(selectedSubjects), Array.from(pageDegreeSubjects), 0);
    });

    function openSubjectsDialog() {
        document.getElementById("subjsPopUp").showModal();
    }

    function closeSubjectsDialog() {
        document.getElementById("subjsPopUp").close();
    }

    function openIcsDialog() {
        document.getElementById("exportIcsDialog").showModal();
    }

    function closeIcsDialog() {
        document.getElementById("exportIcsDialog").close();
    }
</script>
{{ end }}