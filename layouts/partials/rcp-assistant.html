<style>
    :root {
        --text-color: #333333;
        --item-bg-color: #f0f0f0;
        --result-bg-color: #f9f9f9;
        --result-border-color: #e0e0e0;
        --coverage-bg-color: #ddeffe;
    }
    @media (prefers-color-scheme: dark) {
        :root {
            --text-color: #e0e0e0;
            --item-bg-color: #1e1e1e;
            --result-bg-color: #1e1e1e;
            --result-border-color: #333333;
            --coverage-bg-color: #555555;
        }
    }
    #courseSelection {
        max-width: 1000px;
    }
    #description {
        margin-bottom: 20px;
        font-style: italic;
    }
    #courseList {
        list-style-type: none;
        padding: 0;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
    }
    #courseList li {
        background-color: var(--item-bg-color);
        border-radius: 4px;
        padding: 10px;
        height: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: left;
        min-height: 100px;
        max-height: 100px;
        white-space: normal;
        word-wrap: break-word;
    }
    #courseList li label {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        height: 100%;
        white-space: normal;
        overflow: visible;
        text-overflow: ellipsis;
        color: var(--text-color);
        text-align: left;
    }
    #courseList li input[type="checkbox"] {
        margin-right: 10px;
        flex-shrink: 0;
    }
    .button-container {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        max-width: 1000px;
    }
    button {
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }
    .primary-button {
        background-color: #2196f3;
        color: white;
    }
    .primary-button:hover {
        background-color: #1e88e5;
    }
    .secondary-button {
        background-color: #555555;
        color: white;
    }
    .secondary-button:hover {
        background-color: #444444;
    }
    .tertiary-button {
        background-color: #ff9800;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .tertiary-button:hover {
        background-color: #fb8c00;
    }
    #results {
        margin-top: 20px;
    }
    .result-item {
        background-color: var(--result-bg-color);
        border: 1px solid var(--result-border-color);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
    }
    .result-title {
        font-size: 20px;
        font-weight: bold;
        color: #2196f3;
        margin-bottom: 10px;
    }
    .coverage-info {
        font-size: 16px;
        color: var(--text-color);
        background-color: var(--coverage-bg-color);
        padding: 5px 10px;
        border-radius: 4px;
        margin-bottom: 10px;
    }
    .covered-courses {
        font-style: italic;
        color: var(--text-color);
        margin-top: 10px;
        padding: 5px 0;
    }
    .exam-list {
        display: none;
        list-style-type: decimal;
        margin-top: 10px;
        padding-left: 20px;
    }
    .exam-list li {
        margin-bottom: 5px;
        word-wrap: break-word;
        overflow-wrap: anywhere;
    }
    .exam-list li.covered {
        font-weight: bold;
        color: #388e3c;
    }
    .exam-list li.free-choice {
        color: #2196f3;
        font-style: italic;
    }
    .excluded-exams {
        margin-top: 15px;
        color: #666;
        font-style: italic;
    }

    .free-choice-notice {
        margin-top: 10px;
        color: #2196f3;
        font-weight: bold;
        margin-bottom: 15px;
    }

    .free-choice-details {
        font-weight: normal;
        margin-top: 5px;
        line-height: 1.4;
    }
    #searchContainer {
        margin-bottom: 20px;
    }
    #searchInput {
        width: 100%;
        max-width: 1000px;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
        background-color: var(--bg-color);
        color: var(--text-color);
    }
    @media (prefers-color-scheme: dark) {
        .exam-list li.covered {
            color: #81c784;
        }
    }
    @media (max-width: 600px) {
        body {
            padding: 5px;
        }
        #courseList {
            grid-template-columns: 1fr;
            justify-items: center;
            padding: 0 10px;
        }
        #courseList li {
            font-size: 16px;
            padding: 10px;
            height: auto;
            min-height: 60px;
            width: calc(100% - 20px);
            max-width: 300px;
            max-height: none;
        }
        #courseList li label {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            height: auto;
            text-align: left;
            white-space: normal;
            overflow: visible;
        }
        #courseList li input[type="checkbox"] {
            margin-right: 10px;
            flex-shrink: 0;
        }
        .button-container {
            flex-direction: column;
        }
        .button-container button {
            margin-bottom: 10px;
        }
    }
</style>
<body>
    <p id="description">Please select all the courses you are interested in:</p>
    <div id="searchContainer">
        <input
            type="text"
            id="searchInput"
            placeholder="Search for courses..."
        />
    </div>
    <div id="courseSelection">
        <ul id="courseList"></ul>
    </div>
    <div id="results" style="display: none">
        <h2>Top 5 Recommended Combinations:</h2>
        <div id="resultsList"></div>
    </div>
    <div class="button-container">
        <button
            onclick="calculateResults()"
            class="primary-button"
            id="calculateButton"
        >
            Submit
        </button>
        <button
            onclick="resetSelection()"
            class="secondary-button"
            id="resetButton"
        >
            Clear
        </button>
        <button
            onclick="editSelection()"
            class="primary-button"
            id="editButton"
            style="display: none"
        >
            Edit Selection
        </button>
    </div>
    <script>
        const RCP = JSON.parse("{{ .Site.Data.rcpData.RCP | jsonify }}");

        const relatedCourses = JSON.parse(
            "{{ .Site.Data.rcpData.relatedCourses | jsonify }}",
        );

        const rcpCoursesSet = new Set(RCP.flatMap(([, courses]) => courses));
        const relatedCoursesSet = new Set(relatedCourses);

        const allCourses = [...rcpCoursesSet.union(relatedCoursesSet)].sort();

        const notInRCP = relatedCoursesSet.difference(rcpCoursesSet);

        let results = [];

        function populateCourseList() {
            const courseList = document.getElementById("courseList");
            allCourses.forEach((course) => {
                const li = document.createElement("li");
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.id = course;
                checkbox.name = course;
                checkbox.value = course;

                const label = document.createElement("label");
                label.htmlFor = course;
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(course));

                li.appendChild(label);
                courseList.appendChild(li);
            });
        }

        function getSelectedCourses() {
            return Array.from(
                document.querySelectorAll(
                    '#courseList input[type="checkbox"]:checked',
                ),
            ).map((cb) => cb.value);
        }

        function combinations(arr, r) {
            if (r === 1) return arr.map((el) => [el]);
            return arr.flatMap((el, i) =>
                combinations(arr.slice(i + 1), r - 1).map((combo) => [
                    el,
                    ...combo,
                ]),
            );
        }

        function limitNotInRcpCourses(selectedCourses, maxNotInRcp = 4) {
            const notInRcpSelected = selectedCourses.filter((course) =>
                notInRCP.has(course),
            );
            const rcpSelected = selectedCourses.filter(
                (course) => !notInRCP.has(course),
            );

            const limitedNotInRcpSelected = notInRcpSelected.slice(
                0,
                maxNotInRcp,
            );

            return [...rcpSelected, ...limitedNotInRcpSelected];
        }

        function calculateResults() {
            const selectedCourses = getSelectedCourses();
            const limitedSelectedCourses =
                limitNotInRcpCourses(selectedCourses);

            const groupCombinations = combinations(RCP, 2);

            results = groupCombinations.map(([group1, group2]) => {
                const set1 = new Set(group1[1]);
                const set2 = new Set(group2[1]);
                const unionSet = new Set([...set1, ...set2]);
                const allAvailableCourses = [...unionSet];

                const coveredCourses = limitedSelectedCourses.filter((course) =>
                    unionSet.has(course),
                );
                const excludedSelectedCourses = limitedSelectedCourses.filter(
                    (course) => !unionSet.has(course),
                );

                const freeChoiceSlots =
                    allAvailableCourses.length < 13
                        ? 13 - allAvailableCourses.length
                        : 0;

                const additionalCoverage = Math.min(
                    freeChoiceSlots,
                    excludedSelectedCourses.length,
                );
                const totalCoverage =
                    coveredCourses.length + additionalCoverage;

                const coverableByFreeChoice = excludedSelectedCourses.slice(
                    0,
                    freeChoiceSlots,
                );

                return {
                    groups: [group1, group2],
                    coverage: totalCoverage,
                    baseCoverage: coveredCourses.length,
                    coveredCourses: coveredCourses,
                    allCourses: allAvailableCourses,
                    excludedSelectedCourses: excludedSelectedCourses,
                    freeChoiceSlots: freeChoiceSlots,
                    coverableByFreeChoice: coverableByFreeChoice,
                };
            });

            results.sort((a, b) => {
                if (b.coverage !== a.coverage) {
                    return b.coverage - a.coverage;
                }
                return b.baseCoverage - a.baseCoverage;
            });
            displayResults(results.slice(0, 5), selectedCourses.length);

            document.getElementById("description").style.display = "none";
            document.getElementById("searchContainer").style.display = "none";
            window.scrollTo(0, 0);
        }

        function displayResults(results, totalSelected) {
            const resultsDiv = document.getElementById("results");
            const resultsList = document.getElementById("resultsList");
            resultsList.innerHTML = "";

            results.forEach((result, index) => {
                const resultItem = document.createElement("div");
                resultItem.className = "result-item";

                const totalCoverageText = `${result.coverage}/${totalSelected}`;
                const coverageBreakdown = `(${result.baseCoverage} from RCP + ${result.coverableByFreeChoice.length} via free choice)`;

                const freeChoiceText =
                    result.freeChoiceSlots > 0
                        ? `<div class="free-choice-notice">
                            This combination allows for ${
                                result.freeChoiceSlots
                            } free choice course${
                                result.freeChoiceSlots > 1 ? "s" : ""
                            }.
                           </div>`
                        : "";

                resultItem.innerHTML = `
                        <div class="result-title">${result.groups[0][0]} + ${
                            result.groups[1][0]
                        }</div>
                        <div class="coverage-info">Selected courses covered: ${totalCoverageText} ${coverageBreakdown}</div>
                        <p class="covered-courses">Covered courses: ${result.coveredCourses.join(
                            ", ",
                        )}</p>
                        ${freeChoiceText}
                        <button class="tertiary-button" onclick="toggleExamList(${index})">Show All Courses</button>
                        <ol class="exam-list" id="examList${index}" style="display: none">
                            ${result.allCourses
                                .sort()
                                .map(
                                    (course) => `
                                    <li class="${
                                        result.coveredCourses.includes(course)
                                            ? "covered"
                                            : ""
                                    }">${course}</li>
                                `,
                                )
                                .join("")}
                            ${result.coverableByFreeChoice
                                .map(
                                    (course) => `
                                    <li class="free-choice">${course} (free choice)</li>
                                `,
                                )
                                .join("")}
                        </ol>
                    `;
                resultsList.appendChild(resultItem);
            });

            document.getElementById("courseSelection").style.display = "none";
            resultsDiv.style.display = "block";
            document.getElementById("calculateButton").style.display = "none";
            document.getElementById("resetButton").style.display = "none";
            document.getElementById("editButton").style.display =
                "inline-block";
        }

        function toggleExamList(index) {
            const examList = document.getElementById(`examList${index}`);
            const button = examList.previousElementSibling;

            const isCurrentlyHidden =
                examList.style.display === "none" ||
                examList.style.display === "";

            examList.style.display = isCurrentlyHidden ? "block" : "none";
            button.textContent = isCurrentlyHidden
                ? "Hide All Courses"
                : "Show All Courses";
        }

        function resetSelection() {
            document
                .querySelectorAll('#courseList input[type="checkbox"]')
                .forEach((checkbox) => (checkbox.checked = false));

            const searchInput = document.getElementById("searchInput");
            searchInput.value = "";
            searchCourses();

            window.scrollTo(0, 0);
        }

        function editSelection() {
            document.getElementById("results").style.display = "none";
            document.getElementById("courseSelection").style.display = "block";
            document.getElementById("calculateButton").style.display =
                "inline-block";
            document.getElementById("resetButton").style.display =
                "inline-block";
            document.getElementById("editButton").style.display = "none";
            document.getElementById("description").style.display = "block";
            document.getElementById("searchContainer").style.display = "block";
        }

        function searchCourses() {
            const searchInput = document.getElementById("searchInput");
            const filter = searchInput.value.toLowerCase();
            const courseItems = document.querySelectorAll("#courseList li");

            courseItems.forEach((item) => {
                const text = item.textContent || item.innerText;
                if (text.toLowerCase().indexOf(filter) > -1) {
                    item.style.display = "";
                } else {
                    item.style.display = "none";
                }
            });
        }

        window.onload = function () {
            populateCourseList();
            document
                .getElementById("searchInput")
                .addEventListener("keyup", searchCourses);
        };
    </script>
</body>
