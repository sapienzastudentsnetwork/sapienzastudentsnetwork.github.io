<style>
    :root {
        --text-color: #333333;
        --item-bg-color: #f0f0f0;
        --result-bg-color: #f9f9f9;
        --result-border-color: #e0e0e0;
        --coverage-bg-color: #ddeffe;
        --primary-color: #2196f3;
        --primary-hover: #1e88e5;
        --secondary-color: #555555;
        --secondary-hover: #444444;
        --tertiary-color: #ff9800;
        --tertiary-hover: #fb8c00;
        --success-color: #388e3c;
        --success-light: #81c784;
        --border-radius: 4px;
        --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        --transition: all 0.2s ease-in-out;
        --selected-bg-color: #e3f2fd;
        --selected-border-color: #90caf9;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --text-color: #e0e0e0;
            --item-bg-color: #1e1e1e;
            --result-bg-color: #1e1e1e;
            --result-border-color: #333333;
            --coverage-bg-color: #2c2c2c;
            --selected-bg-color: #1a3f5f;
            --selected-border-color: #235d8f;
        }
    }

    #courseSelection {
        max-width: 1000px;
        margin: 0 auto;
    }

    #description {
        margin-bottom: 20px;
        font-style: italic;
        color: var(--text-color);
    }

    #courseList {
        list-style-type: none;
        padding: 0;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
    }

    #courseList li {
        background-color: var(--item-bg-color);
        border-radius: var(--border-radius);
        padding: 10px;
        min-height: 100px;
        max-height: 100px;
        transition: var(--transition);
    }

    #courseList li:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }

    #courseList li label {
        display: flex;
        align-items: center;
        width: 100%;
        height: 100%;
        color: var(--text-color);
        cursor: pointer;
    }

    #courseList li input[type="checkbox"] {
        margin-right: 10px;
        flex-shrink: 0;
    }

    #courseList li:has(input[type="checkbox"]:checked) {
        background-color: var(--selected-bg-color);
        border-color: var(--selected-border-color);
    }

    .button-container {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        max-width: 1000px;
    }

    button {
        padding: 10px 15px;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 16px;
        transition: var(--transition);
    }

    .primary-button {
        background-color: var(--primary-color);
        color: white;
    }

    .primary-button:hover {
        background-color: var(--primary-hover);
    }

    .secondary-button {
        background-color: var(--secondary-color);
        color: white;
    }

    .secondary-button:hover {
        background-color: var(--secondary-hover);
    }

    .tertiary-button {
        background-color: var(--tertiary-color);
        color: white;
        padding: 8px 12px;
    }

    .tertiary-button:hover {
        background-color: var(--tertiary-hover);
    }

    #results {
        margin-top: 20px;
        max-width: 1000px;
        margin: 0 auto;
    }

    .result-item {
        background-color: var(--result-bg-color);
        border: 1px solid var(--result-border-color);
        box-shadow: var(--shadow);
        padding: 20px;
        margin-bottom: 20px;
        border-radius: var(--border-radius);
        transition: var(--transition);
    }

    .result-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .result-title {
        font-size: 20px;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 10px;
    }

    .coverage-info {
        font-size: 16px;
        color: var(--text-color);
        background-color: var(--coverage-bg-color);
        padding: 5px 10px;
        border-radius: var(--border-radius);
        margin-bottom: 10px;
    }

    .covered-courses {
        font-style: italic;
        color: var(--text-color);
        margin-top: 10px;
        padding: 5px 0;
    }

    .exam-list {
        list-style-type: decimal;
        margin-top: 10px;
        padding-left: 20px;
    }

    .exam-list li {
        margin-bottom: 5px;
        word-wrap: break-word;
        overflow-wrap: anywhere;
    }

    .exam-list li.covered {
        font-weight: bold;
        color: var(--success-color);
    }

    .exam-list li.free-choice {
        color: var(--primary-color);
        font-style: italic;
    }

    .free-choice-notice {
        margin: 10px 0 15px;
        color: var(--primary-color);
        font-weight: bold;
    }

    #searchContainer {
        margin-bottom: 20px;
    }

    #searchInput {
        width: 100%;
        max-width: 1000px;
        padding: 10px;
        font-size: 16px;
        border: 1px solid var(--result-border-color);
        border-radius: var(--border-radius);
        background-color: var(--item-bg-color);
        color: var(--text-color);
        transition: var(--transition);
    }

    #searchInput:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
    }

    #courseList li.add-course-card {
        border: 2px dashed var(--result-border-color);
        display: flex;
        align-items: center;
        justify-content: flex-start;
        cursor: pointer;
        color: var(--secondary-color);
        font-size: 14px;
        gap: 6px;
        transition: var(--transition);
    }

    #courseList li.add-course-card:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .add-course-card .add-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        font-weight: 300;
        line-height: 1;
        flex-shrink: 0;
        transition: var(--transition);
    }

    #courseList li.add-course-card:hover .add-icon {
        transform: scale(1.1);
        background-color: var(--primary-hover);
    }

    #courseList li.add-course-card.editing {
        border-color: var(--primary-color);
        padding: 10px;
        flex-direction: column;
        gap: 8px;
        cursor: default;
    }

    .add-course-card .inline-input {
        width: 100%;
        padding: 8px;
        font-size: 14px;
        border: 1px solid var(--result-border-color);
        border-radius: var(--border-radius);
        background-color: var(--result-bg-color);
        color: var(--text-color);
        outline: none;
        transition: var(--transition);
    }

    .add-course-card .inline-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
    }

    .add-course-card .inline-actions {
        display: flex;
        gap: 6px;
        width: 100%;
    }

    .add-course-card .inline-actions button {
        flex: 1;
        padding: 6px 10px;
        font-size: 13px;
        border-radius: var(--border-radius);
        border: none;
        cursor: pointer;
        transition: var(--transition);
    }

    .add-course-card .inline-confirm {
        background-color: var(--primary-color);
        color: white;
    }

    .add-course-card .inline-confirm:hover {
        background-color: var(--primary-hover);
    }

    .add-course-card .inline-cancel {
        background-color: var(--item-bg-color);
        color: var(--text-color);
        border: 1px solid var(--result-border-color) !important;
    }

    .add-course-card .inline-cancel:hover {
        background-color: var(--result-border-color);
    }

    #courseList li.custom-course {
        border: 2px dashed var(--primary-color);
        position: relative;
    }

    .custom-course-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 22px;
        height: 22px;
        background-color: #e53935;
        color: white;
        border-radius: 50%;
        border: 2px solid var(--result-bg-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        line-height: 1;
        cursor: pointer;
        transition: transform 0.15s ease-in-out;
        z-index: 1;
    }

    .custom-course-badge:hover {
        transform: scale(1.2);
    }

    @media (prefers-color-scheme: dark) {
        .exam-list li.covered {
            color: var(--success-light);
        }

        .custom-course-badge {
            border-color: var(--item-bg-color);
        }
    }

    @media (max-width: 600px) {
        body {
            padding: 10px;
        }

        #courseList {
            grid-template-columns: 1fr;
        }

        #courseList li {
            width: 100%;
            max-width: none;
            min-height: 60px;
            max-height: none;
        }

        #courseList li.add-course-card {
            min-height: 70px;
            font-size: 16px;
        }

        #courseList li.add-course-card.editing {
            min-height: auto;
            max-height: none;
            padding: 14px;
            gap: 10px;
        }

        .add-course-card .inline-input {
            padding: 12px;
            font-size: 16px;
        }

        .add-course-card .inline-actions button {
            padding: 12px 14px;
            font-size: 16px;
            min-height: 44px;
        }

        .custom-course-badge {
            width: 28px;
            height: 28px;
            font-size: 18px;
            top: -10px;
            right: -10px;
        }

        .button-container {
            flex-direction: column;
            align-items: stretch;
        }

        .button-container button {
            margin-bottom: 10px;
        }

        .result-item {
            padding: 15px;
        }
    }
</style>

<body>
    <p id="description">Please select all the courses you are interested in:</p>
    <div id="searchContainer">
        <input type="text" id="searchInput" placeholder="Search for courses..." />
    </div>

    <div id="courseSelection">
        <ul id="courseList"></ul>
    </div>
    <div id="results" style="display: none">
        <h2>Top 5 Recommended Combinations:</h2>
        <div id="resultsList"></div>
    </div>
    <div class="button-container">
        <button onclick="calculateResults()" class="primary-button" id="calculateButton">
            Submit
        </button>
        <button onclick="resetSelection()" class="secondary-button" id="resetButton">
            Clear
        </button>
        <button onclick="editSelection()" class="primary-button" id="editButton" style="display: none">
            Edit Selection
        </button>
    </div>
    <script>
        const MAX_EXAMS = 13;
        const GROUPS_PER_COMBO = 2;
        const MAX_NON_RCP_COURSES = 4;
        const TOP_RESULTS_COUNT = 5;

        const rcpGroups = JSON.parse(
            "{{ .Site.Data.rcpData.RCP | jsonify }}",
        );
        const relatedCourses = JSON.parse(
            "{{ .Site.Data.rcpData.relatedCourses | jsonify }}",
        );

        const rcpCoursesSet = new Set(
            rcpGroups.flatMap(([, courses]) => courses),
        );
        const relatedCoursesSet = new Set(relatedCourses);
        const allCourses = [...rcpCoursesSet.union(relatedCoursesSet)].sort();
        const coursesOnlyInRelated =
            relatedCoursesSet.difference(rcpCoursesSet);

        const MAX_CUSTOM_COURSES = 2;
        const CUSTOM_COURSES_KEY = "rcpCustomCourses";

        let results = [];

        function setDisplay(ids, value) {
            ids.forEach(
                (id) => (document.getElementById(id).style.display = value),
            );
        }

        function getSelectedCourses() {
            return Array.from(
                document.querySelectorAll(
                    '#courseList input[type="checkbox"]:checked',
                ),
            ).map((cb) => cb.value);
        }

        function combinations(arr, size) {
            if (size === 1) {
                return arr.map((el) => [el]);
            }
            return arr.flatMap((el, i) =>
                combinations(arr.slice(i + 1), size - 1).map((combo) => [
                    el,
                    ...combo,
                ]),
            );
        }

        function limitNonRcpCourses(selectedCourses) {
            const nonRcpSelected = selectedCourses.filter((course) =>
                coursesOnlyInRelated.has(course),
            );
            const rcpSelected = selectedCourses.filter(
                (course) => !coursesOnlyInRelated.has(course),
            );
            return [
                ...rcpSelected,
                ...nonRcpSelected.slice(0, MAX_NON_RCP_COURSES),
            ];
        }

        function buildCombinationResults(limitedSelectedCourses) {
            return combinations(rcpGroups, GROUPS_PER_COMBO).map(
                ([group1, group2]) => {
                    const unionSet = new Set([...group1[1], ...group2[1]]);
                    const allAvailableCourses = [...unionSet];

                    const coveredCourses = limitedSelectedCourses.filter(
                        (course) => unionSet.has(course),
                    );
                    const excludedSelectedCourses =
                        limitedSelectedCourses.filter(
                            (course) => !unionSet.has(course),
                        );

                    const freeChoiceSlots = Math.max(
                        0,
                        MAX_EXAMS - allAvailableCourses.length,
                    );
                    const additionalCoverage = Math.min(
                        freeChoiceSlots,
                        excludedSelectedCourses.length,
                    );

                    return {
                        groups: [group1, group2],
                        coverage: coveredCourses.length + additionalCoverage,
                        baseCoverage: coveredCourses.length,
                        coveredCourses,
                        allCourses: allAvailableCourses,
                        excludedSelectedCourses,
                        freeChoiceSlots,
                        coverableByFreeChoice: excludedSelectedCourses.slice(
                            0,
                            freeChoiceSlots,
                        ),
                    };
                },
            );
        }

        function sortByBestCoverage(combinationResults) {
            return combinationResults.sort((a, b) =>
                b.coverage !== a.coverage
                    ? b.coverage - a.coverage
                    : b.baseCoverage - a.baseCoverage,
            );
        }

        function showResults() {
            setDisplay(
                [
                    "description",
                    "searchContainer",
                    "courseSelection",
                    "calculateButton",
                    "resetButton",
                ],
                "none",
            );
            setDisplay(["results", "editButton"], "block");
            window.scrollTo(0, 0);
        }

        function showSelection() {
            setDisplay(["results", "editButton"], "none");
            setDisplay(
                [
                    "courseSelection",
                    "calculateButton",
                    "resetButton",
                    "description",
                    "searchContainer",
                ],
                "block",
            );
            window.scrollTo(0, 0);
        }

        function getCustomCourses() {
            try {
                return JSON.parse(localStorage.getItem(CUSTOM_COURSES_KEY)) || [];
            } catch {
                return [];
            }
        }

        function saveCustomCourses(courses) {
            localStorage.setItem(CUSTOM_COURSES_KEY, JSON.stringify(courses));
        }

        function createAddCourseCard() {
            const li = document.createElement("li");
            li.className = "add-course-card";
            li.id = "addCourseCard";
            li.innerHTML = `<span class="add-icon">+</span><span>Add free-choice course</span>`;
            li.addEventListener("click", () => openInlineEditor(li));
            return li;
        }

        function openInlineEditor(card) {
            if (card.classList.contains("editing")) return;
            card.classList.add("editing");
            card.innerHTML = `
                <input class="inline-input" type="text" placeholder="Course name..." />
                <div class="inline-actions">
                    <button class="inline-confirm" type="button">Add</button>
                    <button class="inline-cancel" type="button">Cancel</button>
                </div>`;

            const input = card.querySelector(".inline-input");
            const confirmBtn = card.querySelector(".inline-confirm");
            const cancelBtn = card.querySelector(".inline-cancel");

            input.focus();

            const confirm = () => {
                const name = input.value.trim();
                if (name) addCustomCourse(name);
            };

            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") confirm();
                if (e.key === "Escape") closeInlineEditor(card);
            });
            confirmBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                confirm();
            });
            cancelBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                closeInlineEditor(card);
            });
        }

        function closeInlineEditor(card) {
            card.classList.remove("editing");
            card.innerHTML = `<span class="add-icon">+</span><span>Add free-choice course</span>`;
            card.addEventListener("click", () => openInlineEditor(card), { once: false });
        }

        function createCourseListItem(course, isCustom) {
            const li = document.createElement("li");
            const checkbox = document.createElement("input");
            const label = document.createElement("label");

            Object.assign(checkbox, {
                type: "checkbox",
                id: course,
                name: course,
                value: course,
            });

            label.htmlFor = course;
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(course));
            li.appendChild(label);

            if (isCustom) {
                li.classList.add("custom-course");

                checkbox.addEventListener("change", () => {
                    if (checkbox.checked && getSelectedCustomCourseCount() > MAX_CUSTOM_COURSES) {
                        checkbox.checked = false;
                        alert(`You can select at most ${MAX_CUSTOM_COURSES} custom free-choice courses at a time.`);
                    }
                });

                const badge = document.createElement("span");
                badge.className = "custom-course-badge";
                badge.textContent = "Ã—";
                badge.title = "Remove custom course";
                badge.addEventListener("click", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    removeCustomCourse(course);
                });
                li.appendChild(badge);
            }

            return li;
        }

        function getSelectedCustomCourseCount() {
            const customCourses = new Set(getCustomCourses());
            return getSelectedCourses().filter((c) => customCourses.has(c)).length;
        }

        let newlyAddedCourse = null;

        function addCustomCourse(name) {
            const customCourses = getCustomCourses();
            const allExisting = [...allCourses, ...customCourses];

            if (allExisting.some((c) => c.toLowerCase() === name.toLowerCase())) {
                alert("This course already exists.");
                return;
            }

            customCourses.push(name);
            saveCustomCourses(customCourses);
            newlyAddedCourse = name;
            populateCourseList();
        }

        function removeCustomCourse(name) {
            const customCourses = getCustomCourses().filter((c) => c !== name);
            saveCustomCourses(customCourses);
            populateCourseList();
        }

        function populateCourseList() {
            const courseList = document.getElementById("courseList");

            const previouslyChecked = new Set(getSelectedCourses());

            courseList.innerHTML = "";
            const fragment = document.createDocumentFragment();

            allCourses.forEach((course) => {
                fragment.appendChild(createCourseListItem(course, false));
            });

            getCustomCourses().forEach((course) => {
                fragment.appendChild(createCourseListItem(course, true));
            });

            // "Add" card at the end
            fragment.appendChild(createAddCourseCard());

            courseList.appendChild(fragment);

            // Restore checked state
            previouslyChecked.forEach((course) => {
                const cb = document.getElementById(course);
                if (cb) cb.checked = true;
            });

            if (newlyAddedCourse) {
                if (getSelectedCustomCourseCount() < MAX_CUSTOM_COURSES) {
                    const cb = document.getElementById(newlyAddedCourse);
                    if (cb) cb.checked = true;
                }
                newlyAddedCourse = null;
            }

            searchCourses();
        }

        function buildExamListHTML(result) {
            const courseItems = result.allCourses
                .sort()
                .map((course) => {
                    const cssClass = result.coveredCourses.includes(course)
                        ? "covered"
                        : "";
                    return `<li class="${cssClass}">${course}</li>`;
                })
                .join("");

            const freeChoiceItems = result.coverableByFreeChoice
                .map(
                    (course) =>
                        `<li class="free-choice">${course} (free choice)</li>`,
                )
                .join("");

            return courseItems + freeChoiceItems;
        }

        function buildResultHTML(result, index, totalSelected) {
            const title = `${result.groups[0][0]} + ${result.groups[1][0]}`;
            const coverageText = `${result.coverage}/${totalSelected}`;
            const breakdown = `(${result.baseCoverage} from RCP + ${result.coverableByFreeChoice.length} via free choice)`;

            const freeChoiceNotice =
                result.freeChoiceSlots > 0
                    ? `<div class="free-choice-notice">This combination allows for ${result.freeChoiceSlots} free choice course${result.freeChoiceSlots > 1 ? "s" : ""}.</div>`
                    : "";

            return `
                <div class="result-title">${title}</div>
                <div class="coverage-info">Selected courses covered: ${coverageText} ${breakdown}</div>
                <p class="covered-courses">Covered courses: ${result.coveredCourses.join(", ")}</p>
                ${freeChoiceNotice}
                <button class="tertiary-button" onclick="toggleExamList(${index})">Show All Courses</button>
                <ol class="exam-list" id="examList${index}" style="display: none">
                    ${buildExamListHTML(result)}
                </ol>`;
        }

        function displayResults(topResults, totalSelected) {
            const resultsList = document.getElementById("resultsList");
            resultsList.innerHTML = "";

            topResults.forEach((result, index) => {
                const resultItem = document.createElement("div");
                resultItem.className = "result-item";
                resultItem.innerHTML = buildResultHTML(
                    result,
                    index,
                    totalSelected,
                );
                resultsList.appendChild(resultItem);
            });
        }

        function toggleExamList(index) {
            const examList = document.getElementById(`examList${index}`);
            const button = examList.previousElementSibling;
            const isHidden =
                examList.style.display === "none" || !examList.style.display;

            examList.style.display = isHidden ? "block" : "none";
            button.textContent = isHidden
                ? "Hide All Courses"
                : "Show All Courses";
        }

        function calculateResults() {
            const selectedCourses = getSelectedCourses();
            const limitedSelectedCourses = limitNonRcpCourses(selectedCourses);

            results = sortByBestCoverage(
                buildCombinationResults(limitedSelectedCourses),
            );

            displayResults(
                results.slice(0, TOP_RESULTS_COUNT),
                selectedCourses.length,
            );
            history.pushState({ page: "results" }, "", "#results");
            showResults();
        }

        function resetSelection() {
            document
                .querySelectorAll('#courseList input[type="checkbox"]')
                .forEach((checkbox) => (checkbox.checked = false));

            document.getElementById("searchInput").value = "";
            searchCourses();
            window.scrollTo(0, 0);
        }

        function editSelection() {
            history.pushState({ page: "selection" }, "", "#selection");
            showSelection();
        }

        function searchCourses() {
            const filter = document
                .getElementById("searchInput")
                .value.toLowerCase();

            document.querySelectorAll("#courseList li").forEach((item) => {
                const text = (
                    item.textContent || item.innerText
                ).toLowerCase();
                item.style.display = text.includes(filter) ? "" : "none";
            });
        }

        window.addEventListener("popstate", (event) => {
            if (event.state?.page === "selection") {
                showSelection();
            } else if (event.state?.page === "results") {
                showResults();
            } else {
                showSelection();
            }
        });

        window.onload = () => {
            populateCourseList();
            document
                .getElementById("searchInput")
                .addEventListener("keyup", searchCourses);
            history.replaceState({ page: "selection" }, "", "#selection");
        };
    </script>
</body>